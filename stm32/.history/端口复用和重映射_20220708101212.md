# 端口复用

* **什么是端口复用？**

STM32有很多的内置外设，这些外设的外部引脚都是与GPIO复用的。也就是说，一个GPIO如果可以复用为内置外设的功能引脚，那么当这个GPIO作为内置外设使用的时候，就叫做复用。

---

* **端口复用配置过程**

  *以PA9，PA10配置为串口1为例*

    * GPIO端口时钟赋能

    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA,ENBLE);

    * 复用外设时钟赋能

    *比如你要将端口PA9，PA10复用为串口，所以要使能串口时钟*

    RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1,ENBLE);

    * 端口模式配置 **GPIO_Init()函数**

    **查表**：

    *《STM32中文参考手册V10》P110 的表格“8.1.11外设的GPIO配置”*

    * 高级定时器TIM1/TIM8
    ![](图片/高级定时器.png)

    * 通用定时器TIM2/3/4/5
    ![](图片/通用定时器.png)

    * USART
    ![](图片/UART.png)

    * SPI
    ![](图片/SPI.png)

    * I2s
    ![](图片/I2S.png)

    * I2c接口
    ![](图片/I2C接口.png)

    * BxCAN
    ![](图片/BxCAN.png)

    * USB
    ![](图片/USB.png)

    1. **本表内容只适用于小容量、中容量和大容量产品。**

    * 全速USB OTG引脚配置
    ![](图片/全速USB.png)
    **通用和复用功能I/O**
    ![](图片/OTG.png)

    1. **本表内容只适用于互联型产品。**
    2. **如果另一个共享的外设要使用OTG_FS_VBUS引脚（PA9）或把它作为通用I/O口，必须激活PHY的断电模式（清除OTG_FS_GCCFG寄存器的位16）。**

    * SDIO
    ![](图片/SDIO.png)
    **ADC输入引脚必须配置为模拟输入**


    * ADC/DAC
    ![](图片/ADC,DAC.png)

    * FSMC
    ![](图片/FSMC.png)

    * 其它I/o功能
    ![](图片/其他IO功能.png)

---

# 重映射

## 什么是端口重映射？

每个内置外设都有若干个输入输出引脚，一般这些引脚的输出端口都是固定不变的，为了让设计工程师可以更好的安排引脚的走向和功能，在STM32中引入了外设引脚重映射的概念，即一个外设的引脚除了具有默认的端口外，还可以通过设置重映射寄存器的方式，把这个外设的引脚映射到其他的端口上去。

为了使不同器件封装的外设IO口达到最优，可以把一些复用功能重新映射到其他的一些引脚上。STM32中有很多内置外设的输入输出引脚都具有重映射（remap）的功能

---

## I/O 端口的重映射

* 重映射技术的需求背景
  * I/O的复用：GPIO和内置外设共用引出管教
  * I/O的重映射：复用功能（AFIO）从不同的GPIO管教引出
  * 方便了PCB的设计，潜在的减少了信号的交叉干扰
  * 分时复用某些外设，虚拟的增加了端口数量

* AFIO 重映射的操作步骤
  1. 使能被重新映射到的I/O端口时钟
  2. 使能被重新映射的外设时钟
  3. **使能AFIO功能的时钟** *（勿忘！）*
  4. 进行重新映射

---

## 部分重映射&完全重映射

  * 部分重映射：功能外设的部分引脚重新映射，还有一部分引脚是原来的默认引脚。

  * 完全重映射：功能外设的所有引脚的所有引脚都重新映射

---

## 引脚重映射配置过程（串口1位例）：

  1. 使能GPIO时钟（重映射后的IO）；
  2. 使能功能外设时钟（例如串口1）；
  3. 使能a